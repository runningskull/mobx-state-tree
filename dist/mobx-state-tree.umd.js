!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("mobx")):"function"==typeof define&&define.amd?define(["exports","mobx"],e):e(t.mobxStateTree=t.mobxStateTree||{},t.mobx)}(this,function(t,e){"use strict";function n(t){return $(t).type}function r(t,e){return $(t).onPatch(e)}function i(t,e){$(t).applyPatches(tt(e))}function o(t,e){return $(t).applySnapshot(e)}function a(t){return $(t).root.storedValue}function s(t,e){var n=Z($(t),e,!1);if(void 0!==n)return n?n.value:void 0}function u(t,e){var n=$(t);n.getChildren().forEach(function(t){M(t.storedValue)&&u(t.storedValue,e)}),e(n.storedValue)}var p=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};function c(t,e){function n(){this.constructor=t}p(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}function l(t,e,n,r){var i,o=arguments.length,a=o<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,n,r);else for(var s=t.length-1;s>=0;s--)(i=t[s])&&(a=(o<3?i(a):o>3?i(e,n,a):i(e,n))||a);return o>3&&a&&Object.defineProperty(e,n,a),a}var h,f,d=function(){function t(t,e,n,r,i,o,a,s){void 0===s&&(s=Q),this.subpath="",this._environment=void 0,this._autoUnbox=!0,this.state=z.INITIALIZING,this.type=t,this.storedValue=o,this._parent=e,this.subpath=n,this.storedValue=o,this._environment=r,this.unbox=this.unbox.bind(this),a&&it(this.storedValue,"$treenode",this);var u=!0;try{a&&it(this.storedValue,"toJSON",U),s(this,i),this.state=z.CREATED,u=!1}finally{u&&(this.state=z.DEAD)}}return Object.defineProperty(t.prototype,"path",{get:function(){return this.parent?this.parent.path+"/"+pt(this.subpath):""},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isRoot",{get:function(){return null===this.parent},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"parent",{get:function(){return this._parent},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"root",{get:function(){return this._parent?this._parent.root:q("This scalar node is not part of a tree")},enumerable:!0,configurable:!0}),t.prototype.setParent=function(t,e){void 0===e&&(e=null),this.parent!==t&&q("Cannot change parent of immutable node"),this.subpath!==e&&(this.subpath=e||"")},Object.defineProperty(t.prototype,"value",{get:function(){return this.type.getValue(this)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"snapshot",{get:function(){return this.type.getSnapshot(this)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isAlive",{get:function(){return this.state!==z.DEAD},enumerable:!0,configurable:!0}),t.prototype.unbox=function(t){return t&&!0===this._autoUnbox?t.value:t},t.prototype.toString=function(){return this.type.name+"@"+(this.path||"<root>")+(this.isAlive?"":"[dead]")},t.prototype.die=function(){this.state=z.DEAD},l([e.observable],t.prototype,"subpath",void 0),t}(),y=1,v=function(){function t(t,n,r,i,o,a,s,u){void 0===u&&(u=Q);var p=this;this.nodeId=++y,this.subpath="",this._parent=null,this._isRunningAction=!1,this.isProtectionEnabled=!0,this.identifierAttribute=void 0,this._environment=void 0,this._autoUnbox=!0,this.state=z.INITIALIZING,this.middlewares=B,this.type=t,this.storedValue=a,this._parent=n,this.subpath=r,this._environment=i,this.unbox=this.unbox.bind(this),this.preboot(),n||(this.identifierCache=new F),s&&it(this.storedValue,"$treenode",this);var c=!0;try{s&&it(this.storedValue,"toJSON",U),this._isRunningAction=!0,u(this,o),this._isRunningAction=!1,n?n.root.identifierCache.addNodeToCache(this):this.identifierCache.addNodeToCache(this),this.fireHook("afterCreate"),this.state=z.CREATED,c=!1}finally{c&&(this.state=z.DEAD)}var l=e.reaction(function(){return p.snapshot},function(t){p.emitSnapshot(t)});l.onError(function(t){throw t}),this.addDisposer(l)}return Object.defineProperty(t.prototype,"path",{get:function(){return this.parent?this.parent.path+"/"+pt(this.subpath):""},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isRoot",{get:function(){return null===this.parent},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"parent",{get:function(){return this._parent},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"root",{get:function(){for(var t,e=this;t=e.parent;)e=t;return e},enumerable:!0,configurable:!0}),t.prototype.setParent=function(t,e){void 0===e&&(e=null),this.parent===t&&this.subpath===e||(t&&(this._parent&&t!==this._parent&&q("A node cannot exists twice in the state tree. Failed to add "+this+" to path '"+t.path+"/"+e+"'."),this._parent||t.root!==this||q("A state tree is not allowed to contain itself. Cannot assign "+this+" to path '"+t.path+"/"+e+"'"),!this._parent&&this.root._environment&&this.root._environment!==t.root._environment&&q("A state tree cannot be made part of another state tree as long as their environments are different.")),this.parent&&!t?this.die():(this.subpath=e||"",t&&t!==this._parent&&(t.root.identifierCache.mergeCache(this),this._parent=t,this.fireHook("afterAttach"))))},t.prototype.fireHook=function(t){var e=this.storedValue&&"object"==typeof this.storedValue&&this.storedValue[t];"function"==typeof e&&e.apply(this.storedValue)},Object.defineProperty(t.prototype,"value",{get:function(){if(this.isAlive)return this.type.getValue(this)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"snapshot",{get:function(){if(this.isAlive)return this.type.getSnapshot(this)},enumerable:!0,configurable:!0}),t.prototype.isRunningAction=function(){return!!this._isRunningAction||!this.isRoot&&this.parent.isRunningAction()},Object.defineProperty(t.prototype,"identifier",{get:function(){return this.identifierAttribute?this.storedValue[this.identifierAttribute]:null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isAlive",{get:function(){return this.state!==z.DEAD},enumerable:!0,configurable:!0}),t.prototype.assertAlive=function(){this.isAlive||q(this+" cannot be used anymore as it has died; it has been removed from a state tree. If you want to remove an element from a tree and let it live on, use 'detach' or 'clone' the value")},t.prototype.getChildNode=function(t){this.assertAlive(),this._autoUnbox=!1;var e=this.type.getChildNode(this,t);return this._autoUnbox=!0,e},t.prototype.getChildren=function(){this.assertAlive(),this._autoUnbox=!1;var t=this.type.getChildren(this);return this._autoUnbox=!0,t},t.prototype.getChildType=function(t){return this.type.getChildType(t)},Object.defineProperty(t.prototype,"isProtected",{get:function(){return this.root.isProtectionEnabled},enumerable:!0,configurable:!0}),t.prototype.assertWritable=function(){this.assertAlive(),!this.isRunningAction()&&this.isProtected&&q("Cannot modify '"+this+"', the object is protected and can only be modified by using an action.")},t.prototype.removeChild=function(t){this.type.removeChild(this,t)},t.prototype.unbox=function(t){return t&&!0===this._autoUnbox?t.value:t},t.prototype.toString=function(){var t=this.identifier?"(id: "+this.identifier+")":"";return this.type.name+"@"+(this.path||"<root>")+t+(this.isAlive?"":"[dead]")},t.prototype.finalizeCreation=function(){if(this.state===z.CREATED){if(this.parent){if(this.parent.state!==z.FINALIZED)return;this.fireHook("afterAttach")}this.state=z.FINALIZED;for(var e=0,n=this.getChildren();e<n.length;e++){var r=n[e];r instanceof t&&r.finalizeCreation()}}},t.prototype.detach=function(){this.isAlive||q("Error while detaching, node is not alive."),this.isRoot||(this.fireHook("beforeDetach"),this._environment=this.root._environment,this.state=z.DETACHING,this.identifierCache=this.root.identifierCache.splitCache(this),this.parent.removeChild(this.subpath),this._parent=null,this.subpath="",this.state=z.FINALIZED)},t.prototype.preboot=function(){var t=this;this.disposers=[],this.middlewares=[],this.snapshotSubscribers=[],this.patchSubscribers=[],this.applyPatches=C(this.storedValue,"@APPLY_PATCHES",function(e){e.forEach(function(e){var n=ht(e.path);G(t,n.slice(0,-1)).applyPatchLocally(n[n.length-1],e)})}).bind(this.storedValue),this.applySnapshot=C(this.storedValue,"@APPLY_SNAPSHOT",function(e){if(e!==t.snapshot)return t.type.applySnapshot(t,e)}).bind(this.storedValue)},t.prototype.die=function(){this.state!==z.DETACHING&&M(this.storedValue)&&(u(this.storedValue,function(e){var n=$(e);n instanceof t&&n.aboutToDie()}),u(this.storedValue,function(e){var n=$(e);n instanceof t&&n.finalizeDeath()}))},t.prototype.aboutToDie=function(){this.disposers.splice(0).forEach(function(t){return t()}),this.fireHook("beforeDestroy")},t.prototype.finalizeDeath=function(){this.root.identifierCache.notifyDied(this);var t,e,n,r=this,i=this.path;t=this,e="snapshot",n=this.snapshot,Object.defineProperty(t,e,{enumerable:!0,writable:!1,configurable:!0,value:n}),this.patchSubscribers.splice(0),this.snapshotSubscribers.splice(0),this.patchSubscribers.splice(0),this.state=z.DEAD,this._parent=null,this.subpath="",Object.defineProperty(this.storedValue,"$mobx",{get:function(){q("This object has died and is no longer part of a state tree. It cannot be used anymore. The object (of type '"+r.type.name+"') used to live at '"+i+"'. It is possible to access the last snapshot of this object using 'getSnapshot', or to create a fresh copy using 'clone'. If you want to remove an object from the tree without killing it, use 'detach' instead.")}})},t.prototype.onSnapshot=function(t){return ot(this.snapshotSubscribers,t)},t.prototype.emitSnapshot=function(t){this.snapshotSubscribers.forEach(function(e){return e(t)})},t.prototype.onPatch=function(t){return ot(this.patchSubscribers,t)},t.prototype.emitPatch=function(t,e){if(this.patchSubscribers.length){var n=function(t){"oldValue"in t||q("Patches without `oldValue` field cannot be inversed");return[function(t){switch(t.op){case"add":return{op:"add",path:t.path,value:t.value};case"remove":return{op:"remove",path:t.path};case"replace":return{op:"replace",path:t.path,value:t.value}}}(t),function(t){switch(t.op){case"add":return{op:"remove",path:t.path};case"remove":return{op:"add",path:t.path,value:t.oldValue};case"replace":return{op:"replace",path:t.path,value:t.oldValue}}}(t)]}(function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];for(var r=0;r<e.length;r++){var i=e[r];for(var o in i)t[o]=i[o]}return t}({},t,{path:e.path.substr(this.path.length)+"/"+t.path})),r=n[0],i=n[1];this.patchSubscribers.forEach(function(t){return t(r,i)})}this.parent&&this.parent.emitPatch(t,e)},t.prototype.addDisposer=function(t){this.disposers.unshift(t)},t.prototype.addMiddleWare=function(t){return ot(this.middlewares,t)},t.prototype.applyPatchLocally=function(t,e){this.assertWritable(),this.type.applyPatchLocally(this,t,e)},l([e.observable],t.prototype,"subpath",void 0),l([e.observable],t.prototype,"_parent",void 0),l([e.computed],t.prototype,"path",null),l([e.computed],t.prototype,"value",null),l([e.computed],t.prototype,"snapshot",null),t}();(f=h||(h={}))[f.String=1]="String",f[f.Number=2]="Number",f[f.Boolean=4]="Boolean",f[f.Date=8]="Date",f[f.Literal=16]="Literal",f[f.Array=32]="Array",f[f.Map=64]="Map",f[f.Object=128]="Object",f[f.Frozen=256]="Frozen",f[f.Optional=512]="Optional",f[f.Reference=1024]="Reference",f[f.Identifier=2048]="Identifier",f[f.Late=4096]="Late",f[f.Refinement=8192]="Refinement",f[f.Union=16384]="Union",f[f.Null=32768]="Null",f[f.Undefined=65536]="Undefined";var b=function(){function t(t){this.isType=!0,this.name=t}return t.prototype.create=function(t,e){return void 0===t&&(t=this.getDefaultSnapshot()),this.instantiate(null,"",e,t).value},t.prototype.isAssignableFrom=function(t){return t===this},t.prototype.validate=function(t,e){return M(t)?n(t)===this||this.isAssignableFrom(n(t))?x():D(e,t):this.isValidSnapshot(t,e)},t.prototype.is=function(t){return 0===this.validate(t,[{path:"",type:this}]).length},t.prototype.reconcile=function(t,e){if(t.snapshot===e)return t;if(M(e)&&$(e)===t)return t;if(t.type===this&&nt(e)&&!M(e)&&(!t.identifierAttribute||t.identifier===e[t.identifierAttribute]))return t.applySnapshot(e),t;var r=t.parent,i=t.subpath;if(t.die(),M(e)&&this.isAssignableFrom(n(e))){var o=$(e);return o.setParent(r,i),o}return this.instantiate(r,i,t._environment,e)},Object.defineProperty(t.prototype,"Type",{get:function(){return q("Factory.Type should not be actually called. It is just a Type signature that can be used at compile time with Typescript, by using `typeof type.Type`")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"SnapshotType",{get:function(){return q("Factory.SnapshotType should not be actually called. It is just a Type signature that can be used at compile time with Typescript, by using `typeof type.SnapshotType`")},enumerable:!0,configurable:!0}),l([e.action],t.prototype,"create",null),t}(),m=function(t){function e(e){return t.call(this,e)||this}return c(e,t),e.prototype.getValue=function(t){return t.storedValue},e.prototype.getSnapshot=function(t){return t.storedValue},e.prototype.getDefaultSnapshot=function(){},e.prototype.applySnapshot=function(t,e){q("Immutable types do not support applying snapshots")},e.prototype.applyPatchLocally=function(t,e,n){q("Immutable types do not support applying patches")},e.prototype.getChildren=function(t){return B},e.prototype.getChildNode=function(t,e){return q("No child '"+e+"' available in type: "+this.name)},e.prototype.getChildType=function(t){return q("No child '"+t+"' available in type: "+this.name)},e.prototype.reconcile=function(t,e){if(t.type===this&&t.storedValue===e)return t;var n=this.instantiate(t.parent,t.subpath,t._environment,e);return t.die(),n},e.prototype.removeChild=function(t,e){return q("No child '"+e+"' available in type: "+this.name)},e}(b);function g(t){return"object"==typeof t&&t&&!0===t.isType}function w(t){return{$MST_UNSERIALIZABLE:!0,type:t}}function A(t,n){e.runInAction(function(){tt(n).forEach(function(e){return function(t,e){var n=s(t,e.path||"");if(!n)return q("Invalid action path: "+(e.path||""));var r=$(n);if("@APPLY_PATCHES"===e.name)return i.call(null,n,e.args[0]);if("@APPLY_SNAPSHOT"===e.name)return o.call(null,n,e.args[0]);"function"!=typeof n[e.name]&&q("Action '"+e.name+"' does not exist in '"+r.path+"'");return n[e.name].apply(n,e.args?e.args.map(function(t){return(e=t)&&"object"==typeof e&&"$MST_DATE"in e?new Date(e.$MST_DATE):e;var e}):[])}(t,e)})})}function V(t,e,r){function i(r){if("action"===r.type&&r.id===r.rootId){var i=$(r.context);e({name:r.name,path:J($(t),i),args:r.args.map(function(t,e){return function(t,e,r,i){if(i instanceof Date)return{$MST_DATE:i.getTime()};if(rt(i))return i;if(M(i))return w("[MSTNode: "+n(i).name+"]");if("function"==typeof i)return w("[function]");if("object"==typeof i&&!et(i)&&!X(i))return w("[object "+(i&&i.constructor&&i.constructor.name||"Complex Object")+"]");try{return JSON.stringify(i),i}catch(t){return w(""+t)}}(0,r.name,0,t)})})}}return void 0===r&&(r=!1),N(t,r?function(t,e){var n=e(t);return i(t),n}:function(t,e){return i(t),e(t)})}var P=1,S=null;function j(){return P++}function T(t,n){var r=$(t.context),i=r._isRunningAction,o=S;r.assertAlive(),r._isRunningAction=!0,S=t;try{return function(t,n,r){var i=function(t,e,n){var r=n.$mst_middleware||B,i=t;for(;i;)i.middlewares&&(r=r.concat(i.middlewares)),i=i.parent;return r}(t,0,r);if(!i.length)return e.action(r).apply(null,n.args);var o=0;return function t(a){var s=i[o++];return s?s(a,t):e.action(r).apply(null,n.args)}(n)}(r,t,n)}finally{S=o,r._isRunningAction=i}}function C(t,e,n){return function(){var r=j();return T({type:"action",name:e,id:r,args:at(arguments),context:t,tree:a(t),rootId:S?S.rootId:r,parentId:S?S.id:0},n)}}function N(t,e){return $(t).addMiddleWare(e)}function O(t){return"function"==typeof t?"<function"+(t.name?" "+t.name:"")+">":M(t)?"<"+t+">":"`"+function(t){try{return JSON.stringify(t)}catch(t){return"<Unserializable: "+t+">"}}(t)+"`"}function _(t){var e,n=t.value,r=t.context[t.context.length-1].type,i=t.context.map(function(t){return t.path}).filter(function(t){return t.length>0}).join("/"),o=i.length>0?'at path "/'+i+'" ':"",a=M(n)?"value of type "+$(n).type.name+":":rt(n)?"value":"snapshot",s=r&&M(n)&&r.is($(n).snapshot);return""+o+a+" "+O(n)+" is not assignable "+(r?"to type: `"+r.name+"`":"")+(t.message?" ("+t.message+")":"")+(r?g(e=r)&&(e.flags&(h.String|h.Number|h.Boolean|h.Date))>0?".":", expected an instance of `"+r.name+"` or a snapshot like `"+r.describe()+"` instead."+(s?" (Note that a snapshot of the provided value is compatible with the targeted type)":""):".")}function I(t,e,n){return t.concat([{path:e,type:n}])}function x(){return B}function D(t,e,n){return[{context:t,value:e,message:n}]}function E(t){return t.reduce(function(t,e){return t.concat(e)},[])}function R(t,e){var n=t.validate(e,[{path:"",type:t}]);n.length>0&&q("Error while converting "+O(e)+" to `"+t.name+"`:\n"+n.map(_).join("\n"))}var z,k,F=function(){function t(){this.cache=e.observable.map()}return t.prototype.addNodeToCache=function(t){if(t.identifierAttribute){var n=t.identifier;this.cache.has(n)||this.cache.set(n,e.observable.shallowArray());var r=this.cache.get(n);-1!==r.indexOf(t)&&q("Already registered"),r.push(t)}return this},t.prototype.mergeCache=function(t){var e=this;t.identifierCache.cache.values().forEach(function(t){return t.forEach(function(t){e.addNodeToCache(t)})})},t.prototype.notifyDied=function(t){if(t.identifierAttribute){var e=this.cache.get(t.identifier);e&&e.remove(t)}},t.prototype.splitCache=function(e){var n=new t,r=e.path;return this.cache.values().forEach(function(t){for(var e=t.length-1;e>=0;e--)0===t[e].path.indexOf(r)&&(n.addNodeToCache(t[e]),t.splice(e,1))}),n},t.prototype.resolve=function(t,e){var n=this.cache.get(e);if(!n)return null;var r=n.filter(function(e){return t.isAssignableFrom(e.type)});switch(r.length){case 0:return null;case 1:return r[0];default:return q("Cannot resolve a reference to type '"+t.name+"' with id: '"+e+"' unambigously, there are multiple candidates: "+r.map(function(t){return t.path}).join(", "))}},t}();function L(t,e,n,r,i,o,a){if(void 0===o&&(o=K),void 0===a&&(a=Q),M(i)){var s=i.$treenode;return s.isRoot||q("Cannot add an object to a state tree if it is already part of the same or another state tree. Tried to assign an object to '"+(e?e.path:"")+"/"+n+"', but it lives already at '"+s.path+"'"),s.setParent(e,n),s}var u=o(i);if(t.shouldAttachNode){var p=new v(t,e,n,r,i,u,t.shouldAttachNode,a);return p.finalizeCreation(),p}return new d(t,e,n,r,i,u,t.shouldAttachNode,a)}function M(t){return!(!t||!t.$treenode)}function $(t){return M(t)?t.$treenode:q("Value "+t+" is no MST Node")}function U(){return $(this).snapshot}(k=z||(z={}))[k.INITIALIZING=0]="INITIALIZING",k[k.CREATED=1]="CREATED",k[k.FINALIZED=2]="FINALIZED",k[k.DETACHING=3]="DETACHING",k[k.DEAD=4]="DEAD";var H=function(t){return".."};function J(t,e){t.root!==e.root&&q("Cannot calculate relative path: objects '"+t+"' and '"+e+"' are not part of the same object tree");for(var n=ht(t.path),r=ht(e.path),i=0;i<n.length&&n[i]===r[i];i++);return n.slice(i).map(H).join("/")+lt(r.slice(i))}function Z(t,e,n){return void 0===n&&(n=!0),G(t,ht(e),n)}function G(t,e,n){void 0===n&&(n=!0);for(var r=t,i=0;i<e.length;i++){if(""===e[i])r=r.root;else if(".."===e[i])r=r.parent;else{if("."===e[i]||""===e[i])continue;if(r){if(!(r instanceof v))return q("Illegal state");r=r.getChildNode(e[i]);continue}}if(!r)return n?q("Could not resolve '"+e[i]+"' in '"+lt(e.slice(0,i-1))+"', path of the patch does not resolve"):void 0}return r}var W="See https://github.com/mobxjs/mobx-state-tree/issues/399 for more information. Note that the middleware event types starting with `process` now start with `flow`.";var B=Object.freeze([]),Y=Object.freeze({});function q(t){throw void 0===t&&(t="Illegal state"),new Error("[mobx-state-tree] "+t)}function K(t){return t}function Q(){}function X(t){return!(!Array.isArray(t)&&!e.isObservableArray(t))}function tt(t){return t?X(t)?t:[t]:B}function et(t){if(null===t||"object"!=typeof t)return!1;var e=Object.getPrototypeOf(t);return e===Object.prototype||null===e}function nt(t){return!(null===t||"object"!=typeof t||t instanceof Date||t instanceof RegExp)}function rt(t){return null===t||void 0===t||("string"==typeof t||"number"==typeof t||"boolean"==typeof t||t instanceof Date)}function it(t,e,n){Object.defineProperty(t,e,{enumerable:!1,writable:!1,configurable:!0,value:n})}function ot(t,e){return t.push(e),function(){var n,r,i;r=e,-1!==(i=(n=t).indexOf(r))&&n.splice(i,1)}}function at(t){for(var e=new Array(t.length),n=0;n<t.length;n++)e[n]=t[n];return e}var st=function(){};function ut(t){return e=t.name,n=t,r=function(){var t=j(),i=S||q("Not running an action!"),o=arguments;function a(n,o,a){n.$mst_middleware=r.$mst_middleware,T({name:e,type:o,id:t,args:[a],tree:i.tree,context:i.context,parentId:i.id,rootId:i.rootId},n)}return new Promise(function(s,u){var p,c=function(){p=n.apply(null,arguments),l(void 0)};function l(t){var e;try{a(function(t){e=p.next(t)},"flow_resume",t)}catch(t){return void setImmediate(function(){a(function(e){u(t)},"flow_throw",t)})}f(e)}function h(t){var e;try{a(function(t){e=p.throw(t)},"flow_resume_error",t)}catch(t){return void setImmediate(function(){a(function(e){u(t)},"flow_throw",t)})}f(e)}function f(t){if(!t.done)return t.value&&"function"==typeof t.value.then||q("Only promises can be yielded to `async`, got: "+t),t.value.then(l,h);setImmediate(function(){a(function(t){s(t)},"flow_return",t.value)})}c.$mst_middleware=r.$mst_middleware,T({name:e,type:"flow_spawn",id:t,args:at(o),tree:i.tree,context:i.context,parentId:i.id,rootId:i.rootId},c)})};var e,n,r}function pt(t){return t.replace(/~/g,"~1").replace(/\//g,"~0")}function ct(t){return t.replace(/~0/g,"/").replace(/~1/g,"~")}function lt(t){return 0===t.length?"":"/"+t.map(pt).join("/")}function ht(t){var e=t.split("/").map(ct);return""===e[0]?e.slice(1):e}function ft(){return $(this)+"("+this.size+" items)"}function dt(t){var e;if(t||q("Map.put cannot be used to set empty values"),M(t))e=$(t);else{if(!nt(t))return q("Map.put can only be used to store complex values");e=$($(this).type.subType.create(t))}return e.identifierAttribute||q("Map.put can only be used to store complex values that have an identifier type attribute"),this.set(e.identifier,e.value),this}(st=function(t,e){}).ids={};var yt=function(t){function n(n,r){var i=t.call(this,n)||this;return i.shouldAttachNode=!0,i.flags=h.Map,i.createNewInstance=function(){var t=e.observable.shallowMap();return it(t,"put",dt),it(t,"toString",ft),t},i.finalizeNewInstance=function(t,n){var r=t.storedValue;e.extras.interceptReads(r,t.unbox),e.intercept(r,function(t){return i.willChange(t)}),t.applySnapshot(n),e.observe(r,i.didChange)},i.subType=r,i}return c(n,t),n.prototype.instantiate=function(t,e,n,r){return L(this,t,e,n,r,this.createNewInstance,this.finalizeNewInstance)},n.prototype.describe=function(){return"Map<string, "+this.subType.describe()+">"},n.prototype.getChildren=function(t){return t.storedValue.values()},n.prototype.getChildNode=function(t,e){var n=t.storedValue.get(e);return n||q("Not a child "+e),n},n.prototype.willChange=function(t){var e=$(t.object);switch(e.assertWritable(),t.type){case"update":var n=t.newValue;if(n===t.object.get(t.name))return null;this.subType,t.newValue=this.subType.reconcile(e.getChildNode(t.name),t.newValue),this.verifyIdentifier(t.name,t.newValue);break;case"add":this.subType,t.newValue,t.newValue=this.subType.instantiate(e,t.name,void 0,t.newValue),this.verifyIdentifier(t.name,t.newValue)}return t},n.prototype.verifyIdentifier=function(t,e){if(e instanceof v){var n=e.identifier;null!==n&&""+n!=""+t&&q("A map of objects containing an identifier should always store the object under their own identifier. Trying to store key '"+n+"', but expected: '"+t+"'")}},n.prototype.getValue=function(t){return t.storedValue},n.prototype.getSnapshot=function(t){var e={};return t.getChildren().forEach(function(t){e[t.subpath]=t.snapshot}),e},n.prototype.didChange=function(t){var e=$(t.object);switch(t.type){case"update":return void e.emitPatch({op:"replace",path:pt(t.name),value:t.newValue.snapshot,oldValue:t.oldValue?t.oldValue.snapshot:void 0},e);case"add":return void e.emitPatch({op:"add",path:pt(t.name),value:t.newValue.snapshot,oldValue:void 0},e);case"delete":var n=t.oldValue.snapshot;return t.oldValue.die(),void e.emitPatch({op:"remove",path:pt(t.name),oldValue:n},e)}},n.prototype.applyPatchLocally=function(t,e,n){var r=t.storedValue;switch(n.op){case"add":case"replace":r.set(e,n.value);break;case"remove":r.delete(e)}},n.prototype.applySnapshot=function(t,e){var n=t.storedValue,r={};n.keys().forEach(function(t){r[t]=!1}),Object.keys(e).forEach(function(t){n.set(t,e[t]),r[t]=!0}),Object.keys(r).forEach(function(t){!1===r[t]&&n.delete(t)})},n.prototype.getChildType=function(t){return this.subType},n.prototype.isValidSnapshot=function(t,e){var n=this;return et(t)?E(Object.keys(t).map(function(r){return n.subType.validate(t[r],I(e,r,n.subType))})):D(e,t,"Value is not a plain object")},n.prototype.getDefaultSnapshot=function(){return{}},n.prototype.removeChild=function(t,e){t.storedValue.delete(e)},l([e.action],n.prototype,"applySnapshot",null),n}(b);function vt(){return $(this)+"("+this.length+" items)"}var bt=function(t){function n(n,r){var i=t.call(this,n)||this;return i.shouldAttachNode=!0,i.flags=h.Array,i.createNewInstance=function(){var t=e.observable.shallowArray();return it(t,"toString",vt),t},i.finalizeNewInstance=function(t,n){var r=t.storedValue;e.extras.getAdministration(r).dehancer=t.unbox,e.intercept(r,function(t){return i.willChange(t)}),t.applySnapshot(n),e.observe(r,i.didChange)},i.subType=r,i}return c(n,t),n.prototype.describe=function(){return this.subType.describe()+"[]"},n.prototype.instantiate=function(t,e,n,r){return L(this,t,e,n,r,this.createNewInstance,this.finalizeNewInstance)},n.prototype.getChildren=function(t){return t.storedValue.peek()},n.prototype.getChildNode=function(t,e){var n=parseInt(e,10);return n<t.storedValue.length?t.storedValue[n]:q("Not a child: "+e)},n.prototype.willChange=function(t){var e=$(t.object);e.assertWritable();var n=e.getChildren();switch(t.type){case"update":if(t.newValue===t.object[t.index])return null;t.newValue=mt(e,this.subType,[n[t.index]],[t.newValue],[t.index])[0];break;case"splice":var r=t.index,i=t.removedCount,o=t.added;t.added=mt(e,this.subType,n.slice(r,r+i),o,o.map(function(t,e){return r+e}));for(var a=r+i;a<n.length;a++)n[a].setParent(e,""+(a+o.length-i))}return t},n.prototype.getValue=function(t){return t.storedValue},n.prototype.getSnapshot=function(t){return t.getChildren().map(function(t){return t.snapshot})},n.prototype.didChange=function(t){var e=$(t.object);switch(t.type){case"update":return void e.emitPatch({op:"replace",path:""+t.index,value:t.newValue.snapshot,oldValue:t.oldValue?t.oldValue.snapshot:void 0},e);case"splice":for(var n=t.removedCount-1;n>=0;n--)e.emitPatch({op:"remove",path:""+(t.index+n),oldValue:t.removed[n].snapshot},e);for(n=0;n<t.addedCount;n++)e.emitPatch({op:"add",path:""+(t.index+n),value:e.getChildNode(""+(t.index+n)).snapshot,oldValue:void 0},e);return}},n.prototype.applyPatchLocally=function(t,e,n){var r=t.storedValue,i="-"===e?r.length:parseInt(e);switch(n.op){case"replace":r[i]=n.value;break;case"add":r.splice(i,0,n.value);break;case"remove":r.splice(i,1)}},n.prototype.applySnapshot=function(t,e){t.storedValue.replace(e)},n.prototype.getChildType=function(t){return this.subType},n.prototype.isValidSnapshot=function(t,e){var n=this;return X(t)?E(t.map(function(t,r){return n.subType.validate(t,I(e,""+r,n.subType))})):D(e,t,"Value is not an array")},n.prototype.getDefaultSnapshot=function(){return[]},n.prototype.removeChild=function(t,e){t.storedValue.splice(parseInt(e,10),1)},l([e.action],n.prototype,"applySnapshot",null),n}(b);function mt(t,e,n,r,i){for(var o,a,s,u=!1,p=void 0,c=0;u=c<=r.length-1,o=n[c],a=u?r[c]:void 0,((s=a)instanceof d||s instanceof v)&&(a=a.storedValue),o||u;c++)if(u)if(o)if(wt(o,a))n[c]=gt(e,t,""+i[c],a,o);else{p=void 0;for(var l=c;l<n.length;l++)if(wt(n[l],a)){p=n.splice(l,1)[0];break}n.splice(c,0,gt(e,t,""+i[c],a,p))}else M(a)&&$(a).parent===t&&q("Cannot add an object to a state tree if it is already part of the same or another state tree. Tried to assign an object to '"+t.path+"/"+i[c]+"', but it lives already at '"+$(a).path+"'"),n.splice(c,0,gt(e,t,""+i[c],a));else o.die(),n.splice(c,1),c--;return n}function gt(t,e,n,r,i){if(M(r)){var o=$(r);if(o.assertAlive(),null!==o.parent&&o.parent===e)return o.setParent(e,n),i&&i!==o&&i.die(),o}if(i){var a=t.reconcile(i,r);return a.setParent(e,n),a}return t.instantiate(e,n,e._environment,r)}function wt(t,e){return M(e)?$(e)===t:!(!nt(e)||t.snapshot!==e)||!!(t instanceof v&&null!==t.identifier&&t.identifierAttribute&&et(e)&&e[t.identifierAttribute]===t.identifier)}var At="preProcessSnapshot",Vt={afterCreate:"afterCreate",afterAttach:"afterAttach",postProcessSnapshot:"postProcessSnapshot",beforeDetach:"beforeDetach",beforeDestroy:"beforeDestroy"};function Pt(){return $(this).toString()}var St={name:"AnonymousModel",properties:{},initializers:B};function jt(t){return Object.keys(t).reduce(function(t,e){if(e in Vt)return q("Hook '"+e+"' was defined as property. Hooks should be defined as part of the actions");var n=Object.getOwnPropertyDescriptor(t,e);"get"in n&&q("Getters are not supported as properties. Please use views instead");var r,i=n.value;if(null===i)q("The default value of an attribute cannot be null or undefined as the type cannot be inferred. Did you mean `types.maybe(someType)`?");else{if(rt(i))return Object.assign({},t,((r={})[e]=Mt(function(t){switch(typeof t){case"string":return Nt;case"number":return Ot;case"boolean":return _t;case"object":if(t instanceof Date)return Dt}return q("Cannot determine primitive type from value "+t)}(i),i),r));if(g(i))return t;q("function"==typeof i?"Functions are not supported as properties, use views instead":"object"==typeof i?"In property '"+e+"': base model's should not contain complex values: '"+i+"'":"Unexpected value for property '"+e+"'")}},t)}var Tt=function(t){function n(n){var r=t.call(this,n.name||St.name)||this;r.flags=h.Object,r.shouldAttachNode=!0,r.createNewInstance=function(){var t=e.observable.shallowObject(Y);return it(t,"toString",Pt),t},r.finalizeNewInstance=function(t,n){var i=t.storedValue;r.forAllProps(function(r,o){var a;e.extendShallowObservable(i,((a={})[r]=e.observable.ref(o.instantiate(t,r,t._environment,n[r])),a)),e.extras.interceptReads(i,r,t.unbox)}),r.initializers.reduce(function(t,e){return e(t)},i),e.intercept(i,function(t){return r.willChange(t)}),e.observe(i,r.didChange)},r.didChange=function(t){if(r.properties[t.name]){var e=$(t.object),n=t.oldValue?t.oldValue.snapshot:void 0;e.emitPatch({op:"replace",path:pt(t.name),value:t.newValue.snapshot,oldValue:n},e)}};var i=n.name||St.name;return/^\w[\w\d_]*$/.test(i)||q("Typename should be a valid identifier: "+i),Object.assign(r,St,n),r.properties=jt(r.properties),r.propertiesNames=Object.keys(r.properties),Object.freeze(r.properties),r}return c(n,t),n.prototype.cloneAndEnhance=function(t){return new n({name:t.name||this.name,properties:Object.assign({},this.properties,t.properties),initializers:this.initializers.concat(t.initializers||[]),preProcessor:t.preProcessor||this.preProcessor})},n.prototype.actions=function(t){var e=this;return this.cloneAndEnhance({initializers:[function(n){return e.instantiateActions(n,t(n)),n}]})},n.prototype.instantiateActions=function(t,e){et(e)||q("actions initializer should return a plain object containing actions"),Object.keys(e).forEach(function(n){if(n===At)return q("Cannot define action '"+At+"', it should be defined using 'type.preProcessSnapshot(fn)' instead");var r=e[n],i=t[n];if(n in Vt&&i){var o=r;r=n===Vt.postProcessSnapshot?function(t){return o(i(t))}:function(){i.apply(null,arguments),o.apply(null,arguments)}}it(t,n,C(t,n,r))})},n.prototype.named=function(t){return this.cloneAndEnhance({name:t})},n.prototype.props=function(t){return this.cloneAndEnhance({properties:t})},n.prototype.volatile=function(t){var e=this;return this.cloneAndEnhance({initializers:[function(n){return e.instantiateVolatileState(n,t(n)),n}]})},n.prototype.instantiateVolatileState=function(t,n){et(n)||q("state initializer should return a plain object containing views"),e.extendShallowObservable(t,n)},n.prototype.extend=function(t){var e=this;return this.cloneAndEnhance({initializers:[function(n){var r=t(n),i=r.actions,o=r.views,a=r.state,s=function(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(n[r]=t[r]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(t);i<r.length;i++)e.indexOf(r[i])<0&&(n[r[i]]=t[r[i]])}return n}(r,["actions","views","state"]);for(var u in s)q("The `extend` function should return an object with a subset of the fields 'actions', 'views' and 'state'. Found invalid key '"+u+"'");return a&&e.instantiateVolatileState(n,a),o&&e.instantiateViews(n,o),i&&e.instantiateActions(n,i),n}]})},n.prototype.views=function(t){var e=this;return this.cloneAndEnhance({initializers:[function(n){return e.instantiateViews(n,t(n)),n}]})},n.prototype.instantiateViews=function(t,n){et(n)||q("views initializer should return a plain object containing views"),Object.keys(n).forEach(function(r){var i=Object.getOwnPropertyDescriptor(n,r),o=i.value;if("get"in i)if(e.isComputed(t.$mobx.values[r]))t.$mobx.values[r]=e.computed(i.get,{name:r,setter:i.set,context:t});else{var a={};Object.defineProperty(a,r,{get:i.get,set:i.set,enumerable:!0}),e.extendShallowObservable(t,a)}else"function"==typeof o?it(t,r,o):q("A view member should either be a function or getter based property")})},n.prototype.preProcessSnapshot=function(t){var e=this.preProcessor;return e?this.cloneAndEnhance({preProcessor:function(n){return e(t(n))}}):this.cloneAndEnhance({preProcessor:t})},n.prototype.instantiate=function(t,e,n,r){return L(this,t,e,n,this.applySnapshotPreProcessor(r),this.createNewInstance,this.finalizeNewInstance)},n.prototype.willChange=function(t){var e=$(t.object);e.assertWritable();var n=this.properties[t.name];return n&&(t.newValue,t.newValue=n.reconcile(e.getChildNode(t.name),t.newValue)),t},n.prototype.getChildren=function(t){var e=this,n=[];return this.forAllProps(function(r,i){n.push(e.getChildNode(t,r))}),n},n.prototype.getChildNode=function(t,e){if(!(e in this.properties))return q("Not a value property: "+e);var n=t.storedValue.$mobx.values[e].value;return n||q("Node not available for property "+e)},n.prototype.getValue=function(t){return t.storedValue},n.prototype.getSnapshot=function(t){var n=this,r={};return this.forAllProps(function(i,o){e.extras.getAtom(t.storedValue,i).reportObserved(),r[i]=n.getChildNode(t,i).snapshot}),"function"==typeof t.storedValue.postProcessSnapshot?t.storedValue.postProcessSnapshot.call(null,r):r},n.prototype.applyPatchLocally=function(t,e,n){"replace"!==n.op&&"add"!==n.op&&q("object does not support operation "+n.op),t.storedValue[e]=n.value},n.prototype.applySnapshot=function(t,e){var n=this.applySnapshotPreProcessor(e);this.forAllProps(function(e,r){t.storedValue[e]=n[e]})},n.prototype.applySnapshotPreProcessor=function(t){return this.preProcessor?this.preProcessor.call(null,t):t},n.prototype.getChildType=function(t){return this.properties[t]},n.prototype.isValidSnapshot=function(t,e){var n=this,r=this.applySnapshotPreProcessor(t);return et(r)?E(this.propertiesNames.map(function(t){return n.properties[t].validate(r[t],I(e,t,n.properties[t]))})):D(e,r,"Value is not a plain object")},n.prototype.forAllProps=function(t){var e=this;this.propertiesNames.forEach(function(n){return t(n,e.properties[n])})},n.prototype.describe=function(){var t=this;return"{ "+this.propertiesNames.map(function(e){return e+": "+t.properties[e].describe()}).join("; ")+" }"},n.prototype.getDefaultSnapshot=function(){return{}},n.prototype.removeChild=function(t,e){t.storedValue[e]=null},l([e.action],n.prototype,"applySnapshot",null),n}(b);var Ct=function(t){function e(e,n,r,i){void 0===i&&(i=K);var o=t.call(this,e)||this;return o.shouldAttachNode=!1,o.flags=n,o.checker=r,o.initializer=i,o}return c(e,t),e.prototype.describe=function(){return this.name},e.prototype.instantiate=function(t,e,n,r){return L(this,t,e,n,r,this.initializer)},e.prototype.isValidSnapshot=function(t,e){return rt(t)&&this.checker(t)?x():D(e,t,"Value is not a "+("Date"===this.name?"Date or a unix milliseconds timestamp":this.name))},e}(m),Nt=new Ct("string",h.String,function(t){return"string"==typeof t}),Ot=new Ct("number",h.Number,function(t){return"number"==typeof t}),_t=new Ct("boolean",h.Boolean,function(t){return"boolean"==typeof t}),It=new Ct("null",h.Null,function(t){return null===t}),xt=new Ct("undefined",h.Undefined,function(t){return void 0===t}),Dt=new Ct("Date",h.Date,function(t){return"number"==typeof t||t instanceof Date},function(t){return t instanceof Date?t:new Date(t)});Dt.getSnapshot=function(t){return t.storedValue.getTime()};var Et=function(t){function e(e){var n=t.call(this,JSON.stringify(e))||this;return n.shouldAttachNode=!1,n.flags=h.Literal,n.value=e,n}return c(e,t),e.prototype.instantiate=function(t,e,n,r){return L(this,t,e,n,r)},e.prototype.describe=function(){return JSON.stringify(this.value)},e.prototype.isValidSnapshot=function(t,e){return rt(t)&&t===this.value?x():D(e,t,"Value is not a literal "+JSON.stringify(this.value))},e}(m);function Rt(t){return new Et(t)}var zt=function(t){function e(e,n,r,i){var o=t.call(this,e)||this;return o.type=n,o.predicate=r,o.message=i,o}return c(e,t),Object.defineProperty(e.prototype,"flags",{get:function(){return this.type.flags|h.Refinement},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"shouldAttachNode",{get:function(){return this.type.shouldAttachNode},enumerable:!0,configurable:!0}),e.prototype.describe=function(){return this.name},e.prototype.instantiate=function(t,e,n,r){return this.type.instantiate(t,e,n,r)},e.prototype.isAssignableFrom=function(t){return this.type.isAssignableFrom(t)},e.prototype.isValidSnapshot=function(t,e){var n=this.type.validate(t,e);if(n.length>0)return n;var r=M(t)?$(t).snapshot:t;return this.predicate(r)?x():D(e,t,this.message(t))},e}(m);var kt=function(t){function e(e,n,r){var i=t.call(this,e)||this;return i.dispatcher=null,i.dispatcher=r,i.types=n,i}return c(e,t),Object.defineProperty(e.prototype,"flags",{get:function(){var t=h.Union;return this.types.forEach(function(e){t|=e.flags}),t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"shouldAttachNode",{get:function(){return this.types.some(function(t){return t.shouldAttachNode})},enumerable:!0,configurable:!0}),e.prototype.isAssignableFrom=function(t){return this.types.some(function(e){return e.isAssignableFrom(t)})},e.prototype.describe=function(){return"("+this.types.map(function(t){return t.describe()}).join(" | ")+")"},e.prototype.instantiate=function(t,e,n,r){return this.determineType(r).instantiate(t,e,n,r)},e.prototype.reconcile=function(t,e){return this.determineType(e).reconcile(t,e)},e.prototype.determineType=function(t){if(null!==this.dispatcher)return this.dispatcher(t);var e=this.types.filter(function(e){return e.is(t)});return e.length>1?q("Ambiguos snapshot "+JSON.stringify(t)+" for union "+this.name+". Please provide a dispatch in the union declaration."):e[0]},e.prototype.isValidSnapshot=function(t,e){if(null!==this.dispatcher)return this.dispatcher(t).validate(t,e);var n=this.types.map(function(n){return n.validate(t,e)}),r=n.filter(function(t){return 0===t.length});return r.length>1?D(e,t,"Multiple types are applicable for the union (hint: provide a dispatch function)"):0===r.length?D(e,t,"No type is applicable for the union").concat(E(n)):x()},e}(m);function Ft(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];var r=g(t)?null:t,i=g(t)?e.concat(t):e,o="("+i.map(function(t){return t.name}).join(" | ")+")";return new kt(o,i,r)}var Lt=function(t){function e(e,n){var r=t.call(this,e.name)||this;return r.type=e,r.defaultValue=n,r}return c(e,t),Object.defineProperty(e.prototype,"flags",{get:function(){return this.type.flags|h.Optional},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"shouldAttachNode",{get:function(){return this.type.shouldAttachNode},enumerable:!0,configurable:!0}),e.prototype.describe=function(){return this.type.describe()+"?"},e.prototype.instantiate=function(t,e,n,r){if(void 0===r){var i=this.getDefaultValue(),o=M(i)?$(i).snapshot:i;return this.type.instantiate(t,e,n,o)}return this.type.instantiate(t,e,n,r)},e.prototype.reconcile=function(t,e){return this.type.reconcile(t,this.type.is(e)?e:this.getDefaultValue())},e.prototype.getDefaultValue=function(){var t="function"==typeof this.defaultValue?this.defaultValue():this.defaultValue;return this.defaultValue,t},e.prototype.isValidSnapshot=function(t,e){return void 0===t?x():this.type.validate(t,e)},e.prototype.isAssignableFrom=function(t){return this.type.isAssignableFrom(t)},e}(m);function Mt(t,e){return new Lt(t,e)}var $t=Mt(It,null);var Ut=function(t){function e(e,n){var r=t.call(this,e)||this;return r._subType=null,r.definition=n,r}return c(e,t),Object.defineProperty(e.prototype,"flags",{get:function(){return this.subType.flags|h.Late},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"shouldAttachNode",{get:function(){return this.subType.shouldAttachNode},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"subType",{get:function(){return null===this._subType&&(this._subType=this.definition()),this._subType},enumerable:!0,configurable:!0}),e.prototype.instantiate=function(t,e,n,r){return this.subType.instantiate(t,e,n,r)},e.prototype.reconcile=function(t,e){return this.subType.reconcile(t,e)},e.prototype.describe=function(){return this.subType.name},e.prototype.isValidSnapshot=function(t,e){return this.subType.validate(t,e)},e.prototype.isAssignableFrom=function(t){return this.subType.isAssignableFrom(t)},e}(m);var Ht=new(function(t){function e(){var e=t.call(this,"frozen")||this;return e.shouldAttachNode=!1,e.flags=h.Frozen,e}return c(e,t),e.prototype.describe=function(){return"<any immutable value>"},e.prototype.instantiate=function(t,e,n,r){return L(this,t,e,n,r)},e.prototype.isValidSnapshot=function(t,e){return"function"==typeof t?D(e,t,"Value is not serializable and cannot be frozen"):x()},e}(m)),Jt=function(){return function(t,e){if(this.mode=t,this.value=e,"object"===t){if(!M(e))return q("Can only store references to tree nodes, got: '"+e+"'");if(!$(e).identifierAttribute)return q("Can only store references with a defined identifier attribute.")}}}(),Zt=function(t){function e(e){var n=t.call(this,"reference("+e.name+")")||this;return n.targetType=e,n.flags=h.Reference,n}return c(e,t),e.prototype.describe=function(){return this.name},e.prototype.isAssignableFrom=function(t){return this.targetType.isAssignableFrom(t)},e.prototype.isValidSnapshot=function(t,e){return"string"==typeof t||"number"==typeof t?x():D(e,t,"Value is not a valid identifier, which is a string or a number")},e}(m),Gt=function(t){function e(e){var n=t.call(this,e)||this;return n.shouldAttachNode=!0,n}return c(e,t),e.prototype.getValue=function(t){if(t.isAlive){var e=t.storedValue;if("object"===e.mode)return e.value;var n=t.root.identifierCache.resolve(this.targetType,e.value);return n?n.value:q("Failed to resolve reference of type "+this.targetType.name+": '"+e.value+"' (in: "+t.path+")")}},e.prototype.getSnapshot=function(t){var e=t.storedValue;switch(e.mode){case"identifier":return e.value;case"object":return $(e.value).identifier}},e.prototype.instantiate=function(t,e,n,r){return L(this,t,e,n,new Jt(M(r)?"object":"identifier",r))},e.prototype.reconcile=function(t,e){if(t.type===this){var n=M(e)?"object":"identifier",r=t.storedValue;if(n===r.mode&&r.value===e)return t}var i=this.instantiate(t.parent,t.subpath,t._environment,e);return t.die(),i},e}(Zt),Wt=function(t){function e(e,n){var r=t.call(this,e)||this;return r.options=n,r.shouldAttachNode=!1,r}return c(e,t),e.prototype.getValue=function(t){if(t.isAlive)return this.options.get(t.storedValue,t.parent?t.parent.storedValue:null)},e.prototype.getSnapshot=function(t){return t.storedValue},e.prototype.instantiate=function(t,e,n,r){return L(this,t,e,n,M(r)?this.options.set(r,t?t.storedValue:null):r)},e.prototype.reconcile=function(t,e){var n=M(e)?this.options.set(e,t?t.storedValue:null):e;if(t.type===this&&t.storedValue===n)return t;var r=this.instantiate(t.parent,t.subpath,t._environment,n);return t.die(),r},e}(Zt);var Bt=function(t){function e(e){var n=t.call(this,"identifier("+e.name+")")||this;return n.identifierType=e,n.shouldAttachNode=!1,n.flags=h.Identifier,n}return c(e,t),e.prototype.instantiate=function(t,e,n,r){return t&&M(t.storedValue)?(t.identifierAttribute&&q("Cannot define property '"+e+"' as object identifier, property '"+t.identifierAttribute+"' is already defined as identifier property"),t.identifierAttribute=e,L(this,t,e,n,r)):q("Identifier types can only be instantiated as direct child of a model type")},e.prototype.reconcile=function(t,e){return t.storedValue!==e?q("Tried to change identifier from '"+t.storedValue+"' to '"+e+"'. Changing identifiers is not allowed."):t},e.prototype.describe=function(){return"identifier("+this.identifierType.describe()+")"},e.prototype.isValidSnapshot=function(t,e){return void 0===t||null===t||"string"==typeof t||"number"==typeof t?this.identifierType.validate(t,e):D(e,t,"Value is not a valid identifier, which is a string or a number")},e}(m);var Yt={enumeration:function(t,e){var n="string"==typeof t?e:t,r=Ft.apply(void 0,n.map(function(t){return Rt(""+t)}));return"string"==typeof t&&(r.name=t),r},model:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n="string"==typeof t[0]?t.shift():"AnonymousModel",r=t.shift()||{};return new Tt({name:n,properties:r})},compose:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n="string"==typeof t[0]?t.shift():"AnonymousModel";return t.reduce(function(t,e){return t.cloneAndEnhance({name:t.name+"_"+e.name,properties:e.properties,initializers:e.initializers})}).named(n)},reference:function(t,e){return e?new Wt(t,e):new Gt(t)},union:Ft,optional:Mt,literal:Rt,maybe:function(t){return Ft($t,t)},refinement:function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n="string"==typeof t[0]?t.shift():g(t[0])?t[0].name:null,r=t[0],i=t[1],o=t[2]?t[2]:function(t){return"Value does not respect the refinement predicate"};return new zt(n,r,i,o)},string:Nt,boolean:_t,number:Ot,Date:Dt,map:function(t){return new yt("map<string, "+t.name+">",t)},array:function(t){return new bt(t.name+"[]",t)},frozen:Ht,identifier:function(t){return void 0===t&&(t=Nt),new Bt(t)},late:function(t,e){var n="string"==typeof t?t:"late("+t.toString()+")";return new Ut(n,"string"==typeof t?e:t)},undefined:xt,null:It};t.types=Yt,t.typecheck=R,t.escapeJsonPath=pt,t.unescapeJsonPath=ct,t.decorate=function(t,e){return e.$mst_middleware?e.$mst_middleware.push(t):e.$mst_middleware=[t],e},t.addMiddleware=N,t.process=function(t){return st("process","`process()` has been renamed to `flow()`. "+W),ut(t)},t.isStateTreeNode=M,t.flow=ut,t.applyAction=A,t.onAction=V,t.recordActions=function(t){var e={actions:[],stop:function(){return n()},replay:function(t){A(t,e.actions)}},n=V(t,e.actions.push.bind(e.actions));return e},t.createActionTrackingMiddleware=function(t){var e=new Map;return function(n,r){switch(n.type){case"action":if(t.filter&&!0!==t.filter(n))return r(n);var i=t.onStart(n);t.onResume(n,i),e.set(n.id,{call:n,context:i,async:!1});try{var o=r(n);return t.onSuspend(n,i),!1===e.get(n.id).async&&t.onSuccess(n,i,o),o}catch(e){throw t.onFail(n,i,e),e}case"flow_spawn":return(a=e.get(n.rootId)).async=!0,r(n);case"flow_resume":case"flow_resume_error":var a=e.get(n.rootId);t.onResume(n,a.context);try{return r(n)}finally{t.onSuspend(n,a.context)}case"flow_throw":return a=e.get(n.rootId),e.delete(n.id),t.onFail(n,a.context,n.args[0]),r(n);case"flow_return":return a=e.get(n.rootId),e.delete(n.id),t.onSuccess(n,a.context,n.args[0]),r(n)}}},t.getType=n,t.getChildType=function(t,e){return $(t).getChildType(e)},t.onPatch=r,t.onSnapshot=function(t,e){return $(t).onSnapshot(e)},t.applyPatch=i,t.recordPatches=function(t){var e=null;function n(){e||(e=r(t,function(t,e){o.rawPatches.push([t,e])}))}var o={rawPatches:[],get patches(){return this.rawPatches.map(function(t){return t[0]})},get inversePatches(){return this.rawPatches.map(function(t){return t[0],t[1]})},stop:function(){e&&e(),e=null},resume:n,replay:function(e){i(e||t,o.patches)},undo:function(e){i(e||t,o.inversePatches.slice().reverse())}};return n(),o},t.protect=function(t){var e=$(t);e.isRoot||q("`protect` can only be invoked on root nodes"),e.isProtectionEnabled=!0},t.unprotect=function(t){var e=$(t);e.isRoot||q("`unprotect` can only be invoked on root nodes"),e.isProtectionEnabled=!1},t.isProtected=function(t){return $(t).isProtected},t.applySnapshot=o,t.getSnapshot=function(t){return $(t).snapshot},t.hasParent=function(t,e){void 0===e&&(e=1);for(var n=$(t).parent;n;){if(0==--e)return!0;n=n.parent}return!1},t.getParent=function(t,e){void 0===e&&(e=1);for(var n=e,r=$(t).parent;r;){if(0==--n)return r.storedValue;r=r.parent}return q("Failed to find the parent of "+$(t)+" at depth "+e)},t.getRoot=a,t.getPath=function(t){return $(t).path},t.getPathParts=function(t){return ht($(t).path)},t.isRoot=function(t){return $(t).isRoot},t.resolvePath=function(t,e){var n=Z($(t),e);return n?n.value:void 0},t.resolveIdentifier=function(t,e,n){var r=$(e).root.identifierCache.resolve(t,""+n);return r?r.value:void 0},t.tryResolve=s,t.getRelativePath=function(t,e){return J($(t),$(e))},t.clone=function(t,e){void 0===e&&(e=!0);var n=$(t);return n.type.create(n.snapshot,!0===e?n.root._environment:!1===e?void 0:e)},t.detach=function(t){return $(t).detach(),t},t.destroy=function(t){var e=$(t);e.isRoot?e.die():e.parent.removeChild(e.subpath)},t.isAlive=function(t){return $(t).isAlive},t.addDisposer=function(t,e){$(t).addDisposer(e)},t.getEnv=function(t){var e=$(t).root._environment;return e||Y},t.walk=u,Object.defineProperty(t,"__esModule",{value:!0})});
